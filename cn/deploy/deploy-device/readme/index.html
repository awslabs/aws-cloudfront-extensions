<!doctype html><html lang=cn class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.79.1"><meta name=description content><link rel="shortcut icon" href=https://awslabs.github.io/aws-cloudfront-extensions/images/favicon.ico type=image/x-icon><title>部署Lambda@Edge实现根据设备类型返回相应内容 :: CloudFront Extensions</title><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/nucleus.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/fontawesome-all.min.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/hybrid.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/featherlight.min.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/perfect-scrollbar.min.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/auto-complete.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/atom-one-dark-reasonable.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/theme.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/hugo-theme.css?1630394804 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/css/theme-cloudfrontext.css?1630394804 rel=stylesheet><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/jquery-3.3.1.min.js?1630394804></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/deploy-device/readme/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://awslabs.github.io/aws-cloudfront-extensions/><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/logo.png alt="AWS Logo" width=44% height=44%></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/lunr.min.js?1630394804></script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/auto-complete.js?1630394804></script><script type=text/javascript>var baseurl="https:\/\/awslabs.github.io\/aws-cloudfront-extensions\/\/cn";</script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/js/search.js?1630394804></script></div><div class=highlightable><ul class=topics><li data-nav-id=/cn/prerequisite/ title=开始前的准备 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/prerequisite/>开始前的准备</a><ul><li data-nav-id=/cn/prerequisite/aws-cloudshell/readme/ title="AWS CloudShell" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/prerequisite/aws-cloudshell/readme/>AWS CloudShell</a></li><li data-nav-id=/cn/prerequisite/aws-cdk/readme/ title="AWS CDK" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/prerequisite/aws-cdk/readme/>AWS CDK</a></li><li data-nav-id=/cn/prerequisite/aws-config/readme/ title=配置证书 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/prerequisite/aws-config/readme/>配置证书</a></li></ul></li><li data-nav-id=/cn/deploy/ title="部署CloudFront Extensions" class="dd-item
parent"><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/>部署CloudFront Extensions</a><ul><li data-nav-id=/cn/deploy/deploy-auth/readme/ title=部署Lambda@Edge实现Cognito鉴权 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/deploy-auth/readme/>部署Lambda@Edge实现Cognito鉴权</a></li><li data-nav-id=/cn/deploy/deploy-device/readme/ title=部署Lambda@Edge实现根据设备类型返回相应内容 class="dd-item active"><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/deploy-device/readme/>部署Lambda@Edge实现根据设备类型返回相应内容</a></li></ul></li><li data-nav-id=/cn/contribution/ title=贡献 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/contribution/>贡献</a></li><li data-nav-id=/cn/reference/ title=参考资料 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/reference/>参考资料</a></li><li data-nav-id=/cn/cleanup/ title=清理 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/>清理</a><ul><li data-nav-id=/cn/cleanup/s3-bucket/readme/ title=S3桶 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/s3-bucket/readme/>S3桶</a></li><li data-nav-id=/cn/cleanup/cognito-user-pool/readme/ title=Cognito用户池 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/cognito-user-pool/readme/>Cognito用户池</a></li><li data-nav-id=/cn/cleanup/cf-distribution/readme/ title=CloudFront分配 class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/cf-distribution/readme/>CloudFront分配</a></li><li data-nav-id=/cn/cleanup/cloudformation/readme/ title=CloudFormation class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/cloudformation/readme/>CloudFormation</a></li><li data-nav-id=/cn/cleanup/cloudshell/readme/ title=CloudShell class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/cleanup/cloudshell/readme/>CloudShell</a></li></ul></li></ul><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value;">
<option id=en value=https://awslabs.github.io/aws-cloudfront-extensions/deploy/deploy-device/readme/>English</option>
<option id=cn value=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/deploy-device/readme/ selected>Chinese</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li></ul></section><section id=footer><left><a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-cloud-download aria-label="Repo of awslabs/aws-cloudfront-extension on GitHub">Repo</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-star data-show-count=false aria-label="Star awslabs/aws-cloudfront-extension on GitHub">Star</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions/fork data-icon=octicon-repo-forked data-show-count=false aria-label="Fork awslabs/aws-cloudfront-extension on GitHub">Fork</a><p><a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | © 2021, Amazon Web Services, Inc. or its affiliates. All rights reserved</p></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/>CloudFront Extensions workshop</a> > <a href=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/>部署CloudFront Extensions</a> > 部署Lambda@Edge实现根据设备类型返回相应内容</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#通过sar部署应用>通过SAR部署应用</a></li><li><a href=#通过cdk部署网站>通过CDK部署网站</a></li><li><a href=#配置cloudfront分配>配置CloudFront分配</a></li><li><a href=#配置cloudfront作为lambda的触发器>配置CloudFront作为Lambda的触发器</a></li><li><a href=#测试>测试</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>部署Lambda@Edge实现根据设备类型返回相应内容</h1><p>在本章中, 您将会在SAR（Serverless Application Repository）中查找并部署一个已发布的无服务器应用。此应用会根据设备类型返回相应内容，例如在手机上访问此网页，会返回手机端网页，在PC浏览器上访问同一网页，会返回桌面端网页</p><p>如下是本实验的架构图</p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/cloudfront-device-arch.png alt="Auth Architecture"></p><p>S3桶包含一个实验网站的内容，桶中有如下4个文件夹：</p><ul><li>desktop: 如果请求是来源于PC浏览器，此文件夹的资源将会返回</li><li>mobile: 如果请求是来源于手机，此文件夹的资源将会返回</li><li>smarttv: 如果请求是来源于智能电视，此文件夹的资源将会返回</li><li>tablet: 如果请求是来源于平板电脑，此文件夹的资源将会返回</li></ul><p>实现原理如下</p><ol><li>用户向CloudFront发送查看者请求</li><li>CloudFront将如下请求头转发到源站服务器，此请求头通过查看者请求中的User-Agent获得。 CloudFront会将如下请求头设置为true或者false，例如，如果请求是来源于手机，CloudFront会将CloudFront-Is-Mobile-Viewer设置为true并把其他三个请求头设置为false<ul><li>CloudFront-Is-Desktop-Viewer</li><li>CloudFront-Is-Mobile-Viewer</li><li>CloudFront-Is-SmartTV-Viewer</li><li>CloudFront-Is-Tablet-Viewer</li></ul></li><li>CloudFront将请求路由到最近的AWS边缘节点。在源请求阶段，CloudFront REC（区域边缘缓存）上会触发一个Lambda@Edge函数</li><li>此Lambda@Edge函数根据请求头重写URI，例如，如果请求来源于手机，那么它将会请求mobile文件夹中的资源</li><li>S3桶的相应文件夹中的资源将会返回给用户</li></ol><h2 id=通过sar部署应用>通过SAR部署应用</h2><p>本步骤中，您将通过SAR(Serverless Application Repository)部署一个Lambda函数到您的账号</p><ol><li>打开<a href=https://serverlessrepo.aws.amazon.com/applications>AWS SAR(Serverless Application Repository)页面</a></li><li>勾选搜索栏下方的<strong>Show apps that create custom IAM roles or resource policies</strong>复选框</li><li>在搜索栏中输入<strong>serving-based-on-device</strong>并搜索, 点击应用链接进入应用详情页面，点击<strong>Deploy</strong>按钮<blockquote><p>您可通过搜索关键字<strong>aws-cloudfront-extensions</strong>找到所有CloudFront extensions</p></blockquote></li><li>在应用详情页面中，勾选<strong>I acknowledge that this app creates custom IAM roles</strong></li><li>点击<strong>Deploy</strong>按钮。等待直到部署成功，部署完成后会自动跳转到无服务器应用页面</li></ol><h2 id=通过cdk部署网站>通过CDK部署网站</h2><p>本步骤中，您将会通过CDK(Cloud Development Kit)部署实验网站，本实验使用CloudShell作为CDK运行环境</p><p>下载CloudFront Extensions代码并上传到CloudShell</p><blockquote><p>如果您已经在CloudShell中有CloudFront Extensions代码，您可跳过此步骤</p></blockquote><ol><li><p>访问<a href=https://github.com/awslabs/aws-cloudfront-extensions>CloudFront Extensions代码</a></p></li><li><p>选择<strong>Download ZIP</strong>
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/gh-download.png alt="Github Download ZIP"></p></li><li><p>将zip包上传到CloudShell
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/cs-upload.png alt="CloudShell Upload"></p></li><li><p>解压到home文件夹</p><pre><code>unzip aws-cloudfront-extensions-main.zip
</code></pre><div class="notices note"><p>您也可通过SSH或Https下载代码</p></div><blockquote><p>若使用SSH, 您需要按照链接中的操作设置您的github账号的ssh key <a href=https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent>doc</a></p></blockquote><blockquote><p>若使用Https, 您需要输入github用户名和密码。如果您已开启two-factor authentication(2FA)，下载代码时您还将需要<a href=https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token>personal access key</a></p></blockquote></li></ol><p>部署实验网站</p><ol><li><p>进入<a href="https://console.aws.amazon.com/cloudshell/home?region=us-east-1#">CloudShell</a></p><blockquote><p>请确保右上角的区域选择为： <strong>弗吉尼亚北部 (us-east-1)</strong></p></blockquote></li><li><p>进入demo文件夹并执行部署，如下命令会创建一个存有网站内容的S3桶，您需要在执行命令时指定一个独一无二的S3桶名字</p><pre><code>cd aws-cloudfront-extensions-main/templates/workshop-demo/
npm install
npm run build
# Need to specify an unique S3 bucket name in below command, eg. cloudfront-extension-workshop 
cdk deploy --parameters staticSiteBucketName=&lt;your_unique_S3_bucket_name&gt;
</code></pre><p>等待直到部署完成</p><p>如果这是您第一次使用CDK，您需要首先进行bootstrap，否则在执行CDK命令时会报如下错误</p><pre><code>❌  WorkshopDemoStack failed: Error: This stack uses assets, so the toolkit stack must be deployed to the environment (Run &quot;cdk bootstrap aws://unknown-account/unknown-region&quot;)
at Object.addMetadataAssetsToManifest (/usr/lib/node_modules/aws-cdk/lib/assets.ts:27:11)
at Object.deployStack (/usr/lib/node_modules/aws-cdk/lib/api/deploy-stack.ts:205:29)
at processTicksAndRejections (internal/process/task_queues.js:97:5)
at CdkToolkit.deploy (/usr/lib/node_modules/aws-cdk/lib/cdk-toolkit.ts:180:24)
at initCommandLine (/usr/lib/node_modules/aws-cdk/bin/cdk.ts:204:9)
This stack uses assets, so the toolkit stack must be deployed to the environment (Run &quot;cdk bootstrap aws://unknown-account/unknown-region&quot;)
</code></pre><p>执行如下命令进行bootstrap</p><pre><code>cdk bootstrap aws://&lt;replace_with_your_aws_account_id&gt;/us-east-1   
</code></pre></li><li><p>进入<a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1">CloudFormation console</a>，您将会看到一个名叫<strong>WorkshopDemoStack</strong>的堆栈</p></li><li><p>选择<strong>WorkshopDemoStack</strong>并点击<strong>输出</strong>标签页，你将会在看到创建的S3桶名称，demo website url和CloudFront分配id
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/output_device.png alt="Device output"></p></li></ol><h2 id=配置cloudfront分配>配置CloudFront分配</h2><p>本步骤中，您将配置CloudFront分配</p><ol><li><p>进入<a href=https://console.aws.amazon.com/cloudfront/home#>CloudFront console</a></p></li><li><p>选择上面步骤部署完成的分配</p></li><li><p>进入<strong>行为</strong>标签页，选择列表中的默认行为并点击编辑按钮</p></li><li><p>按照如下进行配置</p><ul><li><p>在<strong>缓存键和源请求</strong>中，选择<strong>Legacy cache settings</strong>，然后在<strong>标题</strong>中，选择<strong>包含以下标题</strong>，并添加如下四个标头</p><p>CloudFront-Is-Desktop-Viewer</p><p>CloudFront-Is-Mobile-Viewer</p><p>CloudFront-Is-SmartTV-Viewer</p><p>CloudFront-Is-Tablet-Viewer</p><blockquote><p>在请求回源前，CloudFront会根据User-Agent请求头将此四个请求头设置为true或false</p></blockquote></li><li><p>在<strong>对象缓存</strong>, 选择<strong>Customize</strong></p><p>将Minimum TTL、Maximum TTL、Default TTL都设置为0</p><blockquote><p>此操作是为了禁用CloudFront缓存，从而每次请求都会回源</p></blockquote></li><li><p>点击最下方<strong>保存更改</strong>按钮保存</p></li></ul><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/cf-config-device.png alt="Device CF config"></p></li><li><p>选择<strong>源</strong>标签页，勾选源并点击右上角<strong>编辑</strong>按钮</p></li><li><p>按照如下进行配置</p><ul><li>将<strong>S3 存储桶访问</strong>设置为<strong>是的，使用 OAI (存储桶可以限制只访问 CloudFront)</strong><div class="notices note"><pre><code> 如果您不能在页面上看到**S3 存储桶访问**选项，将**源域**下拉框中的内容删除，然后重新设置为您的S3桶用来刷新页面
</code></pre></div></li><li>在<strong>来源访问标识</strong>中，点击<strong>创建新的OAI</strong>按钮</li><li>在<strong>存储桶策略</strong>中，选择<strong>是，更新存储桶策略</strong>选项</li><li>点击最下方<strong>保存更改</strong>按钮
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/device-OAI.png alt="Device Origin config"></li></ul></li><li><p>等待直到CloudFront分配部署完成</p></li></ol><h2 id=配置cloudfront作为lambda的触发器>配置CloudFront作为Lambda的触发器</h2><p>本步骤中，您将为上面部署完成的Lambda配置触发器</p><ol><li><p>进入<a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions">Lambda console</a> 并选择刚才通过SAR部署完成的<strong>ServingOnDeviceFunction</strong>函数</p></li><li><p>点击右上角<strong>操作</strong>菜单并选择<strong>部署到Lambda@Edge</strong>
<img src=https://awslabs.github.io/aws-cloudfront-extensions/images/CF_trigger_3.png alt="CF Trigger"></p></li><li><p>在<strong>部署到Lambda@Edge</strong>页面中，输入如下内容：</p><ul><li><p>分配</p><p>上面步骤中通过CloudFormation堆栈创建的CloudFront分配</p></li><li><p>CloudFront事件</p><p>在下拉框中，选择<strong>源请求</strong></p></li></ul><p>点击<strong>部署</strong>按钮</p></li><li><p>等待Lambda函数部署完成</p></li><li><p>您可打开<a href=https://console.aws.amazon.com/cloudfront/>CloudFront Console</a>查看部署进展</p></li></ol><h2 id=测试>测试</h2><ol><li><p>在浏览器中打开上面步骤中CloudFormation堆栈输出的<strong>demo website url</strong></p><p>网页上会显示<strong>T-Rex Runner for Desktop</strong>并且x-cache请求头为<strong>miss from cloudfront</strong>或<strong>refreshhit from cloudfront</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/test_desktop.png alt="Device test result desktop"></p></li><li><p>在手机浏览器中打开同样的网站链接</p><p>网页上会显示<strong>T-Rex Runner for Mobile</strong>并且x-cache请求头为<strong>miss from cloudfront</strong>或<strong>refreshhit from cloudfront</strong></p><p><img src=https://awslabs.github.io/aws-cloudfront-extensions/images/test_mobile.png alt="Device test result mobile"></p></li></ol><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=https://awslabs.github.io/aws-cloudfront-extensions/cn/deploy/deploy-auth/readme/ title=部署Lambda@Edge实现Cognito鉴权><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=https://awslabs.github.io/aws-cloudfront-extensions/cn/contribution/ title=贡献 style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/clipboard.min.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/perfect-scrollbar.min.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/perfect-scrollbar.jquery.min.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/jquery.sticky.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/featherlight.min.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/highlight.pack.js?1630394804></script><script>hljs.initHighlightingOnLoad();</script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/modernizr.custom-3.6.0.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/learn.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/js/hugo-learn.js?1630394804></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/mermaid/mermaid.js?1630394804></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>