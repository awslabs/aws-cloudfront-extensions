<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.79.1"><meta name=description content><link rel="shortcut icon" href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/favicon.ico type=image/x-icon><title>Deploy WAF & Shield Automations :: CloudFront Extensions</title><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/nucleus.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/fontawesome-all.min.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/hybrid.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/featherlight.min.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/perfect-scrollbar.min.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/auto-complete.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/atom-one-dark-reasonable.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/theme.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/hugo-theme.css?1661756110 rel=stylesheet><link href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/css/theme-cloudfrontext.css?1661756110 rel=stylesheet><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/jquery-3.3.1.min.js?1661756110></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/deploy/readme/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/><img src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/logo.png alt="AWS Logo" width=44% height=44%></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/lunr.min.js?1661756110></script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/auto-complete.js?1661756110></script><script type=text/javascript>var baseurl="https:\/\/awslabs.github.io\/aws-cloudfront-extensions\/workshop\/";</script><script type=text/javascript src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/search.js?1661756110></script></div><div class=highlightable><ul class=topics><li data-nav-id=/prerequisite/ title=Prerequisite class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/prerequisite/>Prerequisite</a><ul><li data-nav-id=/prerequisite/aws-cloudshell/readme/ title="AWS CloudShell" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/prerequisite/aws-cloudshell/readme/>AWS CloudShell</a></li><li data-nav-id=/prerequisite/aws-cdk/readme/ title="AWS CDK" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/prerequisite/aws-cdk/readme/>AWS CDK</a></li><li data-nav-id=/prerequisite/aws-config/readme/ title="Configure your credentials" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/prerequisite/aws-config/readme/>Configure your credentials</a></li></ul></li><li data-nav-id=/deploy/ title="Deploy with CloudFront Extensions" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/deploy/>Deploy with CloudFront Extensions</a><ul><li data-nav-id=/deploy/deploy-auth/readme/ title="Deploy a Lambda@Edge function to authenticate with Cognito" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/deploy/deploy-auth/readme/>Deploy a Lambda@Edge function to authenticate with Cognito</a></li><li data-nav-id=/deploy/deploy-device/readme/ title="Deploy a Lambda@Edge function to serve based on devices" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/deploy/deploy-device/readme/>Deploy a Lambda@Edge function to serve based on devices</a></li></ul></li><li data-nav-id=/develop/ title="Develop with CloudFront Extensions" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/>Develop with CloudFront Extensions</a><ul><li data-nav-id=/develop/cloudfront-distribution/readme/ title="Create a CloudFront Distribution" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/cloudfront-distribution/readme/>Create a CloudFront Distribution</a></li><li data-nav-id=/develop/download-code/readme/ title="Upload CloudFront Extensions code into CloudShell" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/download-code/readme/>Upload CloudFront Extensions code into CloudShell</a></li><li data-nav-id=/develop/code-structure/readme/ title="Understand CloudFront Extensions code structure" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/code-structure/readme/>Understand CloudFront Extensions code structure</a></li><li data-nav-id=/develop/edge-function/readme/ title="Create a Lambda@Edge function" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/edge-function/readme/>Create a Lambda@Edge function</a></li><li data-nav-id=/develop/test-function/readme/ title="Test the Lambda@Edge function" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/test-function/readme/>Test the Lambda@Edge function</a></li><li data-nav-id=/develop/trigger-function/readme/ title="Trigger from CloudFront" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/develop/trigger-function/readme/>Trigger from CloudFront</a></li></ul></li><li data-nav-id=/security/ title="WAF & Shield Deployment" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security/>WAF & Shield Deployment</a><ul><li data-nav-id=/security/guide/readme/ title=Deployment class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security/guide/readme/>Deployment</a></li></ul></li><li data-nav-id=/security-practice/ title="WAF & Shield Best Practice" class="dd-item
parent"><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/>WAF & Shield Best Practice</a><ul><li data-nav-id=/security-practice/juice-shop/readme/ title="Deploy OWASP Juice Shop" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/juice-shop/readme/>Deploy OWASP Juice Shop</a></li><li data-nav-id=/security-practice/deploy/readme/ title="Deploy WAF & Shield Automations" class="dd-item active"><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/deploy/readme/>Deploy WAF & Shield Automations</a></li><li data-nav-id=/security-practice/rule-testing/readme/ title="Web ACLs and Managed Rules" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/rule-testing/readme/>Web ACLs and Managed Rules</a></li><li data-nav-id=/security-practice/flood-testing/readme/ title="Prevent DDoS attacks" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/flood-testing/readme/>Prevent DDoS attacks</a></li></ul></li><li data-nav-id=/contribution/ title=Contribution class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/contribution/>Contribution</a><ul><li data-nav-id=/contribution/pr/readme/ title="Contributing via pull requests" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/contribution/pr/readme/>Contributing via pull requests</a></li><li data-nav-id=/contribution/bug-report/readme/ title="Reporting issues" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/contribution/bug-report/readme/>Reporting issues</a></li></ul></li><li data-nav-id=/cleanup/ title=Cleanup class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/>Cleanup</a><ul><li data-nav-id=/cleanup/s3-bucket/readme/ title="S3 bucket" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/s3-bucket/readme/>S3 bucket</a></li><li data-nav-id=/cleanup/cognito-user-pool/readme/ title="Cognito User Pool" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/cognito-user-pool/readme/>Cognito User Pool</a></li><li data-nav-id=/cleanup/cf-distribution/readme/ title="CloudFront distribution" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/cf-distribution/readme/>CloudFront distribution</a></li><li data-nav-id=/cleanup/cloudformation/readme/ title=CloudFormation class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/cloudformation/readme/>CloudFormation</a></li><li data-nav-id=/cleanup/cloudshell/readme/ title=CloudShell class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/cloudshell/readme/>CloudShell</a></li><li data-nav-id=/cleanup/waf/readme/ title="WAF & Shield Automations" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/cleanup/waf/readme/>WAF & Shield Automations</a></li></ul></li><li data-nav-id=/reference/ title="Reference & Resources" class=dd-item><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/reference/>Reference & Resources</a></li></ul><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value;">
<option id=en value=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/deploy/readme/ selected>English</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li></ul></section><section id=footer><left><a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-cloud-download aria-label="Repo of awslabs/aws-cloudfront-extension on GitHub">Repo</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions data-icon=octicon-star data-show-count=false aria-label="Star awslabs/aws-cloudfront-extension on GitHub">Star</a>
<a class=github-button href=https://github.com/awslabs/aws-cloudfront-extensions/fork data-icon=octicon-repo-forked data-show-count=false aria-label="Fork awslabs/aws-cloudfront-extension on GitHub">Fork</a><p><a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | © 2021, Amazon Web Services, Inc. or its affiliates. All rights reserved</p></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/>CloudFront Extensions workshop</a> > <a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/>WAF & Shield Best Practice</a> > Deploy WAF & Shield Automations
          
  </span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#deploy-waf--shield-automations>Deploy WAF & Shield Automations</a></li><li><a href=#configure-web-access-logging>Configure Web Access Logging</a></li><li><a href=#aws-shield-deployment>AWS Shield Deployment</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Deploy WAF & Shield Automations</h1><h2 id=deploy-waf--shield-automations>Deploy WAF & Shield Automations</h2><p>Please follow this previous step to <a href=https://awslabs.github.io/aws-cloudfront-extensions/develop/download-code/readme/>Upload CloudFront Extensions code into CloudShell</a> if have not unzipped the CloudFront Extensions repository in the CloudShell.</p><p>After unzipping the aws-cloudfront-extensions archive, you can deploy the WAF & Shield Automations in the CloudShell by the next commands:</p><ol><li><p>Create a symbolic link to <a href=https://pypi.org/project/pip/>PIP</a> from PIP3</p><pre><code>sudo ln -s /usr/bin/pip3 /usr/bin/pip
</code></pre></li><li><p>Change the current directory to &lsquo;aws-cloudfront-waf/deployment&rsquo;</p><pre><code>cd aws-cloudfront-extensions-main/templates/aws-cloudfront-waf/deployment/
</code></pre></li><li><p>Package all required AWS Lambda functions</p><pre><code> ./build-s3-dist.sh
</code></pre></li><li><p>Navigate to the aws-cloudfront-waf directory and deploy the WAF & Shield Automations app by AWS CDK</p><pre><code> cd ..
 cdk deploy
</code></pre></li></ol><p>This CDK app uses the following default values, you can modify them by &ndash;parameters flags at deployment.</p><table><thead><tr><th>Parameter</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>appAccessLogBucket</td><td>access-log-bucket-cloudfront</td><td>The name for the Amazon S3 bucket where you want to store Cloud Front access logs for your CloudFront distribution.</td></tr><tr><td>wafLogBucketName</td><td>waf-log-bucket-cloudfront</td><td>The name for the Amazon S3 bucket where you want to store WAF access Cloud Front logs.</td></tr><tr><td>errorThreshold</td><td>50</td><td>The maximum acceptable bad requests per minute per IP.</td></tr><tr><td>requestThreshold</td><td>100</td><td>The maximum acceptable requests per FIVE-minute period per IP address.</td></tr><tr><td>blockPeriod</td><td>240</td><td>The period (in minutes) to block applicable IP addresses.</td></tr><tr><td>waf2Scope</td><td>CLOUDFRONT</td><td>Specifies whether this is for an AWS CloudFront distribution or for a regional application. A regional application can be an Application Load Balancer (ALB), an Amazon API Gateway REST API, or an AWS AppSync GraphQL API. Valid Values are CLOUDFRONT and REGIONAL. For CLOUDFRONT, you must create your WAFv2 resources in the US East (N. Virginia) Region, us-east-1.</td></tr></tbody></table><p>Enter <strong>y</strong> to deploy the stack and create the resources.</p><p>The output should look like the following:</p><pre><code>✅  AwsCloudfrontWafStack

Outputs:
AwsCloudfrontWafStack.ApiGatewayBadBotEndpointDEAB6B1B = https://************us-east-1amazonawcom/prod/
AwsCloudfrontWafStack.AppAccessLogBucketName = ************
AwsCloudfrontWafStack.WAFWebACLArn arn:aws:wafv2:us-east-1:************:globalwebaclCloudFront-Web-WAF/************
AwsCloudfrontWafStack.WAFWebACLName = ************
AwsCloudfrontWafStack.WafLogBucketName = ************
Stack ARN:
arn:aws:cloudformation:us-east-1:************:stack/AwsCloudfrontWafStack/************
</code></pre><p>In the CloudFormation Console, you will see the CDK apps are deployed through AWS CloudFormation.
<img src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/cdk_cloudformation_completed.png alt="CloudFormation Console"></p><h2 id=configure-web-access-logging>Configure Web Access Logging</h2><p>Configure Juice Shop web application’s distribution in Amazon CloudFront to send web access logs to the appAccessLogBucket in Amazon S3 bucket so that this data is available for the Log Parser AWS Lambda function.</p><ol><li>Open the Amazon CloudFront console</li><li>Select your Juice Shop web application&rsquo;s distribution, and choose Distribution Settings.</li><li>On the General tab, choose Edit.</li><li>For AWS WAF Web ACL, choose the web ACL just created (you can find the <code>WAFWebACLName</code> in the CloudShell output).</li><li>For Logging, choose On.</li><li>For Bucket for Logs, choose the <code>appAccessLogBucket</code> bucket to store web access logs.</li><li>Set the log prefix as AWSLogs/.</li><li>Click &lsquo;Yes, Edit&rsquo; to save changes.
<img src="https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/config_waf_log.png?width=50pc" alt="Config Logging"></li></ol><h2 id=aws-shield-deployment>AWS Shield Deployment</h2><p>In the AWS Lambda console, update the <code>ShieldAdvancedLambda</code> function with the ARN of the Juice Shop CloudFront distribution.</p><ol><li>Open the Amazon CloudFront console</li><li>Select your Juice Shop web application&rsquo;s distribution and copy the ARN in the General tab
<img src="https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/juice_shop_arn.png?width=50pc" alt="Juice Shop ARN"></li><li>Open the Amazon Lambda console, on the Functions list, open the <code>ShieldAdvancedLambda</code> Lambda function, click the Lambda item in the Designer and open the shield-protection.py source code in the &lsquo;Function code&rsquo;, replace the <code>CloudFrontARN</code> variable in line 31 with the copied ARN.
<img src="https://awslabs.github.io/aws-cloudfront-extensions/workshop/images/replace_arn.png?width=50pc" alt="Replace ARN"></li><li>Click the Deploy button until you see the &lsquo;Changes deployed&rsquo; notice, then click the Test button to launch the function with the default testing event, after testing, you will see the success execution result in the summary.</li></ol><p>So far, the deployment of AWF WAF and Shield has been finished and associated with the Juice Shop CloudFront distribution. Let&rsquo;s start testing in the <a href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security/rule-testing/readme/>next step</a>.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/juice-shop/readme/ title="Deploy OWASP Juice Shop"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=https://awslabs.github.io/aws-cloudfront-extensions/workshop/security-practice/rule-testing/readme/ title="Web ACLs and Managed Rules" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/clipboard.min.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/perfect-scrollbar.min.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/perfect-scrollbar.jquery.min.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/jquery.sticky.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/featherlight.min.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/highlight.pack.js?1661756110></script><script>hljs.initHighlightingOnLoad();</script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/modernizr.custom-3.6.0.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/learn.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/js/hugo-learn.js?1661756110></script><script src=https://awslabs.github.io/aws-cloudfront-extensions/workshop/mermaid/mermaid.js?1661756110></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>